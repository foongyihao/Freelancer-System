<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CDN Freelancers</title>
<style>
body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
header { display:flex; justify-content:space-between; align-items:center; }
section { margin-top:1.5rem; }
input, textarea, button, select { padding:.5rem; margin:.25rem 0; }
#freelancers tbody tr.archived { background:#f5d7d7; }
.badge { background:#1976d2; color:#fff; padding:2px 6px; border-radius:4px; font-size:.75rem; margin-right:4px; display:inline-block; }
.hobbies .badge { background:#9c27b0; }
.flex { display:flex; gap:1rem; flex-wrap:wrap; }
.card { border:1px solid #ccc; padding:1rem; border-radius:8px; width:320px; position:relative; }
.card .arch { position:absolute; top:8px; right:8px; font-size:.7rem; background:#444; color:#fff; padding:2px 4px; border-radius:3px; }
.error-box { display:none; background:#fdecea; color:#611a15; border:1px solid #f5c6cb; padding:.75rem 1rem; border-radius:6px; margin-top:1rem; position:relative; }
.error-box button { position:absolute; top:4px; right:6px; background:none; border:none; color:#611a15; cursor:pointer; font-size:14px; }
</style>
</head>
<body>
<header>
  <h1>CDN Freelancers</h1>
  <div>
    <label><input type="checkbox" id="showArchived" /> Show Archived</label>
  </div>
</header>
<section>
  <h2>Create / Edit</h2>
  <form id="freelancerForm">
    <input type="hidden" id="freelancerId" />
    <div><label>Username<br><input id="username" required /></label></div>
    <div><label>Email<br><input id="email" type="email" required /></label></div>
    <div><label>Phone<br><input id="phone" /></label></div>
    <div><label>Skillsets (comma separated)<br><input id="skillsets" placeholder="C#,SQL" /></label></div>
    <div><label>Hobbies (comma separated)<br><input id="hobbies" placeholder="Music,Chess" /></label></div>
    <button type="submit">Save</button>
    <button type="button" id="resetBtn">Reset</button>
  </form>
</section>
<section>
  <h2>Search</h2>
  <input id="searchTerm" placeholder="search username/email" />
  <button id="searchBtn">Search</button>
  <button id="refreshBtn">All</button>
</section>
<section>
  <h2>Freelancers</h2>
  <div id="error" class="error-box"><button aria-label="Dismiss" onclick="clearError()">âœ•</button><span id="errorMsg"></span></div>
  <div id="list" class="flex"></div>
  <div id="pager" style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
    <button id="prevBtn">Prev</button>
    <span id="pageInfo"></span>
    <button id="nextBtn">Next</button>
  </div>
</section>
<script>
async function api(path, opts={}) {
  try {
    const resp = await fetch(path, { headers: { 'Content-Type':'application/json' }, ...opts });
    if(!resp.ok){
      let msg;
      try { const data = await resp.json(); msg = data.title || data.message || JSON.stringify(data); }
      catch { msg = await resp.text(); }
      throw new Error(msg || `Request failed (${resp.status})`);
    }
    try { return await resp.json(); } catch { return null; }
  } catch (err){
    showError(err instanceof Error ? err.message : String(err));
    throw err;
  }
}

function showError(message){
  const box = document.getElementById('error');
  const span = document.getElementById('errorMsg');
  span.textContent = message;
  box.style.display = 'block';
}
function clearError(){
  const box = document.getElementById('error');
  box.style.display = 'none';
  document.getElementById('errorMsg').textContent='';
}

let currentPage = 1;
let totalPages = 1;
const pageSize = 10;
let currentSearch = '';

async function loadAll() {
  const includeArchived = document.getElementById('showArchived').checked;
  clearError();
  const data = await api(`/api/freelancers?includeArchived=${includeArchived}&page=${currentPage}&pageSize=${pageSize}`)
    .catch(()=>null);
  const items = data?.items || [];
  totalPages = data?.totalPages || 1;
  render(items);
  updatePager();
}
async function search() {
  const term = document.getElementById('searchTerm').value.trim();
  currentSearch = term;
  currentPage = 1;
  if(!term){ currentSearch=''; return loadAll(); }
  clearError();
  const data = await api(`/api/freelancers/search?term=${encodeURIComponent(term)}&page=${currentPage}&pageSize=${pageSize}`)
    .catch(()=>null);
  const items = data?.items || [];
  totalPages = data?.totalPages || 1;
  render(items);
  updatePager();
}
function toList(v){ return v.split(',').map(x=>x.trim()).filter(Boolean); }

function render(items){
  const list = document.getElementById('list');
  list.innerHTML='';
  (items||[]).forEach(f=> {
    const card = document.createElement('div');
    card.className='card'+(f.isArchived?' archived':'');
    card.innerHTML = `
      <strong>${f.username}</strong> <span class="arch" style="display:${f.isArchived?'inline':'none'}">ARCHIVED</span><br>
      <small>${f.email}</small><br>
      <small>${f.phoneNumber||''}</small><br>
      <div class="skills">${(f.skillsets||[]).map(s=>`<span class='badge'>${s.name}</span>`).join('')}</div>
      <div class="hobbies">${(f.hobbies||[]).map(h=>`<span class='badge'>${h.name}</span>`).join('')}</div>
      <div style='margin-top:.5rem;'>
        <button data-act='edit'>Edit</button>
        <button data-act='archive'>${f.isArchived?'Unarchive':'Archive'}</button>
        <button data-act='delete'>Delete</button>
      </div>`;
    card.querySelectorAll('button').forEach(btn=> btn.addEventListener('click', ()=> handleAction(f, btn.dataset.act)));
    list.appendChild(card);
  });
}

async function handleAction(f, act){
  if(act==='edit'){
    document.getElementById('freelancerId').value=f.id;
    username.value=f.username; email.value=f.email; phone.value=f.phoneNumber;
    skillsets.value=(f.skillsets||[]).map(s=>s.name).join(',');
    hobbies.value=(f.hobbies||[]).map(h=>h.name).join(',');
    window.scrollTo({top:0, behavior:'smooth'});
  } else if(act==='archive'){
    await fetch(`/api/freelancers/${f.id}/archive?archive=${!f.isArchived}`, { method:'PATCH' });
  if(currentSearch){ search(); } else { loadAll(); }
  } else if(act==='delete'){
    if(confirm('Delete?')){ await fetch(`/api/freelancers/${f.id}`, { method:'DELETE' });
      if(!currentSearch){
        // Adjust page if we deleted last item on page
        const includeArchived = document.getElementById('showArchived').checked;
        const pageCheck = await api(`/api/freelancers?includeArchived=${includeArchived}&page=${currentPage}&pageSize=${pageSize}`);
        if(pageCheck.items && pageCheck.items.length === 0 && currentPage>1){ currentPage--; }
        loadAll();
      } else {
        search();
      }
    }
  }
}

// Form submit
freelancerForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('freelancerId').value;
  const payload = {
    username: username.value.trim(),
    email: email.value.trim(),
    phoneNumber: phone.value.trim(),
    skillsets: toList(skillsets.value),
    hobbies: toList(hobbies.value)
  };
  if(id){
  clearError();
  await api(`/api/freelancers/${id}`, { method:'PUT', body: JSON.stringify(payload) }).catch(()=>{});
  } else {
  clearError();
  await api(`/api/freelancers`, { method:'POST', body: JSON.stringify(payload) }).catch(()=>{});
  }
  resetForm();
  if(currentSearch){ search(); } else { loadAll(); }
});

function resetForm(){
  freelancerForm.reset();
  document.getElementById('freelancerId').value='';
}
resetBtn.addEventListener('click', resetForm);
searchBtn.addEventListener('click', search);
refreshBtn.addEventListener('click', ()=> { currentSearch=''; currentPage=1; loadAll(); });
showArchived.addEventListener('change', ()=> { currentPage=1; currentSearch=''; loadAll(); });
prevBtn.addEventListener('click', ()=> { if(currentPage>1){ currentPage--; loadAll(); }});
nextBtn.addEventListener('click', ()=> { if(currentPage<totalPages){ currentPage++; loadAll(); }});

function updatePager(){
  document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
  document.getElementById('pager').style.display = 'flex';
  prevBtn.disabled = currentPage<=1;
  nextBtn.disabled = currentPage>=totalPages;
}

loadAll();
</script>
</body>
</html>
